{{ $suite := or .suite "trixie" }}
# kernel should be "local" or "debian", default to local for now as the debian
# kernel doesn't work for the one just yet...
{{ $kernel := or .kernel "local" }}
{{ $cmdline := or .cmdline "fw_devlink=permissive clk_ignore_unused" }}
{{ $image := "openwrt.img" }}

architecture: arm64

actions:
  - action: mmdebstrap
    description: Bootstrap Debian {{ $suite }}
    suite: {{ $suite }}
    components:
      - main
      - non-free-firmware
    mirror: https://deb.debian.org/debian
    variant: minbase

  - action: overlay
    description: Setup apt repositories
    source: overlays/debian-backports

  - action: apt
    description: Install systemd
    packages:
      - systemd
      - systemd-repart
      - systemd-resolved
      - systemd-sysv
      - systemd-timesyncd
      - udev

  - action: apt
    description: Install other tools
    update: false
    packages:
      - hostapd
      - iw
      - firmware-mediatek
      - firmware-misc-nonfree
      - vim
      - curl
      - openssh-server
      - iproute2
      - initramfs-tools

{{ if eq $kernel "local" }}
  - action: overlay
    description: Put in local debian kernel
    source: local-kernel
    destination: /kernel

  - action: run
    chroot: true
    command: |
      apt -y --no-install-recommends install /kernel/*.deb
      rm -rf /kernel

{{ else if eq $kernel  "debian" }}
  - action: apt
    description: Install kernel
    packages:
      - linux-image-arm64/trixie-backports
{{ else }}
   {{ fail "Kernel not set to a valid value" }}
{{ end }}

  - action: overlay
    description: Configure networking
    source: overlays/network

  - action: run
    description: Enable network services
    chroot: true
    command: |
      systemctl enable systemd-networkd
      systemctl enable systemd-timesyncd

  - action: image-partition
    imagename: {{ $image }}
    partitiontype: gpt
    imagesize: 3G
    mountpoints:
      - mountpoint: /
        partition: root
    partitions:
      - name: root
        partlabel: root
        parttype: b921b045-1df0-41c3-af44-4c6f280d3fae
        fs: ext4
        start: 1MiB
        end: 100%

  - action: filesystem-deploy
    append-kernel-cmdline: "{{ $cmdline }}"

  - action: apt
    description: Install u-boot-menu
    packages:
      - u-boot-menu

# This needs to run last as apt gets unhappy without machine-id
  - action: run
    description: Setup system for first boot
    chroot: true
    command: |
      echo 'root:!unprovisioned' | chpasswd -c NONE
      rm -f /etc/hostname
      rm -f /etc/hosts
      rm -f /etc/machine-id
      rm -f /etc/ssh/ssh_host_*

  - action: run
    description: Create block map for {{ $image }}.img
    chroot: false
    postprocess: true
    command: cd $ARTIFACTDIR; bmaptool create {{ $image }} > {{ $image }}.bmap

  - action: run
    description: Compress {{ $image }}
    postprocess: true
    command: cd $ARTIFACTDIR; zstd --rm -f {{ $image }}
