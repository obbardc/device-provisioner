{{ $architecture := or .architecture "amd64" }}
{{ $suite := or .suite "trixie" }}
{{ $cmdline := or .cmdline "" }}

{{ $image := or .image "recovery"  }}

architecture: {{ $architecture }}

actions:
  - action: mmdebstrap
    description: Bootstrap Debian {{ $suite }}
    suite: {{ $suite }}
    components:
      - main
      - non-free-firmware
    mirror: https://deb.debian.org/debian
    variant: minbase
    dpkg-opts:
      - "path-exclude=/usr/share/man/*"
      - "path-include=/usr/share/man/"
      - "path-exclude=/usr/share/locale/*"
      - "path-include=/usr/share/locale/locale.alias"
      - "path-exclude=/usr/share/doc/*"
      - "path-exclude=/usr/lib/udev/hwdb.d/*"

  - action: overlay
    description: Setup apt repositories
    source: overlays/debian-backports

  - action: run
    description: Set hostname to recovery-{{ $suite }}
    command: echo "recovery-{{ $suite }}" > ${ROOTDIR}/etc/hostname

  - action: overlay
    description: Setup base config
    source: overlays/config

  - action: run
    description: Set root password to root
    chroot: true
    command: echo "root:root" | chpasswd

  - action: apt
    description: Install systemd
    recommends: false
    packages:
      - systemd
      - systemd-repart
      - systemd-resolved
      - systemd-sysv
      - systemd-timesyncd
      - udev

  - action: apt
    description: Install systemd-boot
    packages:
      - systemd-boot-efi

  - action: apt
    description: Install other tools
    recommends: false
    update: false
    packages:
      - iproute2
      - procps
      - iwd
      - iw
      - firmware-misc-nonfree
      - nvi
      - curl

  - action: apt
    description: Install initramfs tools
    recommends: false
    packages:
      - initramfs-tools

  - action: overlay
    description: Disable initramfs creation
    source: overlays/disable-initramfs

  - action: apt
    description: Install kernel
    recommends: false
    packages:
{{ if eq $architecture "amd64" }}
      - linux-image-amd64/trixie-backports
{{ else if eq $architecture "arm64" }}
      - linux-image-arm64/trixie-backports
  {{ fail "architecture not supported" }}
{{ else }}
  {{ fail "architecture not supported" }}
{{ end }}

  - action: run
    description: init should be /init for initramfs
    chroot: true
    command: ln -s /sbin/init /init

  - action: overlay
    description: Configure networking
    source: overlays/network

  - action: run
    description: Enable network services
    chroot: true
    command: |
      systemctl enable systemd-networkd
      systemctl enable systemd-timesyncd

  - action: overlay
    description: Install flasher
    source: overlays/flasher

  - action: run
    description: Ensure flasher is executable
    chroot: true
    command: chmod a+x /usr/local/bin/flasher

  - action: run
    description: Clean up rootfs
    chroot: true
    command: |
      # Drop apt caches
      rm -rf /var/cache/apt/*
      rm -f /var/lib/apt/lists/*_*

  - action: run
    description: Print image size
    chroot: true
    command: "du -scm --exclude='/proc/*' /*"

  - action: image-partition
    imagename: {{ $image }}.img
    imagesize: 7.5G
    partitiontype: gpt
    mountpoints:
      - mountpoint: /
        partition: EFI
        buildtime: true
      - mountpoint: /mnt
        partition: storage
        buildtime: true
    partitions:
      - name: EFI
        partlabel: efi
        parttype: c12a7328-f81f-11d2-ba4b-00a0c93ec93b
        fs: vfat
        start: 6176s
        end: 512M
        flags: [ boot ]
      - name: storage
        fs: ext4
        start: 512M
        end: 100%

  # TODO: add images to flash
  - action: run
    description: Install images for flashing
    chroot: false
    command: |
      cp ${ARTIFACTDIR}/test.img.zst ${IMAGEMNTDIR}/mnt/
      cp ${ARTIFACTDIR}/test.img.bmap ${IMAGEMNTDIR}/mnt/

  - action: run
    description: Setup recovery image
    chroot: false
    script: scripts/setup-recovery.sh

  # TODO: handled by scripts/setup-recovery.sh
  #- action: run
  #  description: Create cpio archive
  #  chroot: false
  #  command: |
  #    cd ${ROOTDIR}
  #    find . -print | cpio -oH newc > ${ARTIFACTDIR}/recovery.cpio

  # TODO: handled by scripts/setup-recovery.sh
  #- action: run
  #  description: Compressing cpio archive
  #  chroot: false
  #  command: |
  #    zstd -f --rm ${ARTIFACTDIR}/recovery.cpio

  - action: run
    description: Create block map for {{ $image }}.img
    chroot: false
    postprocess: true
    command: cd $ARTIFACTDIR; bmaptool create {{ $image }}.img > {{ $image }}.img.bmap

  # TODO: compress disk image with gzip / bmap to make flashing easier
  - action: run
    description: Compress disk image
    chroot: false
    postprocess: true
    command: |
      zstd -f ${ARTIFACTDIR}/{{ $image }}.img
